(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const r=flarum.core.compat["forum/app"];var n=t.n(r);const o=flarum.core.compat["common/extend"],a=flarum.core.compat["forum/components/CommentPost"];var s=t.n(a);const i=flarum.core.compat["forum/components/DiscussionPage"];var l=t.n(i);const u=flarum.core.compat["forum/resolvers/DiscussionPageResolver"];var c=t.n(u);const d=flarum.core.compat["forum/components/PostStreamScrubber"];var p=t.n(d);flarum.core.compat["forum/components/PostStream"],n().initializers.add("table-of-content",(function(){window.copyTextToClipboard||(window.copyTextToClipboard=function(t){navigator.clipboard?navigator.clipboard.writeText(t).then((function(){alert(n().translator.trans("tohsakarat-table-of-content.forum.settings.copied")+t)}),(function(e){alert("tohsakarat-table-of-content.forum.settings.copyfailed "+t)})):function(t){var e=document.createElement("textarea");e.value=t,e.style.top="0",e.style.left="0",e.style.position="fixed",document.body.appendChild(e),e.focus(),e.select(),document.execCommand("copy"),document.body.removeChild(e)}(t)}),(0,o.extend)(s().prototype,"refreshContent",(function(){var t=this;if(document.querySelector(".PostStream")){var e=function(t){var e=new RegExp(/[\x21-\x2f\x3a-\x40\x5b-\x60\x7B-\x7F]/);return t.replace(e,"-").replaceAll(" ","-")};Array.prototype.slice.call(this.element.querySelectorAll(".Post-body a")).forEach((function(t){var e=window.location.href.replace("https://","").split("/").splice(0,3).join("/");-1!=t.href.indexOf(e)&&(t.onclick=function(e){var r=t.href.split("/")[5].split("#")[0];return console.log("点击了链接,即将前往楼层"+r),e.preventDefault(),window.location.href.split("/")[5].split("#")[0]==r?(console.log("当前所在楼层和目标楼层相同，不滚动"),void(window.location.hash="#"+t.href.split("#")[1])):(n().current.data.stream.goToNumber(r).then((function(){console.log("goto完毕"),t.href.split("/")[5]&&setTimeout((function(){window.location.hash="#"+t.href.split("#")[1],setTimeout((function(){m.redraw(),setTimeout((function(){window.location.hash="#"+t.href.split("#")[1]}),500)}),100)}),500)})),!1)})}));var r=Array.prototype.slice.call(this.element.querySelectorAll(".Post-body :is(h1, h2, h3, h4, h5, h6,.div-anchor):not([data-id])"));r.length&&(r.forEach((function(t,n){for(var o=t;!(o=o.parentNode).dataset.number;);t.innerHTML='<span class="title-anchor"></span><span class="title-sub-anchor">'+t.innerHTML+"</span>";var a=document.createElement("i");a.className="icon fas fa-up-right-from-square Button-icon",t.appendChild(a),t.dataset.id=o.dataset.number+"-"+e(t.innerText)+"-"+(1==r.map((function(t){return e(t.innerText)})).filter((function(r){return r==e(t.innerText)})).length?"":n),t.dataset.id=t.dataset.id.length>10?t.dataset.id.substring(0,10):t.dataset.id,t.dataset.id=encodeURI(t.dataset.id),t.className+=" title-has-anchor",t.querySelector(".title-anchor").id=t.dataset.id,t.querySelector(".title-sub-anchor").id=t.dataset.id})),this.catalog={},this.catalog.id=this.attrs.post.data.id,n().current.data.stream.posts().find((function(e){var r;return(null==e||null==(r=e.data)?void 0:r.id)==t.catalog.id})).catalog=this.catalog,this.catalog.elements=r,this.catalog.content=this.catalog.elements.map((function(e){var r=-1!=Array(e.classList).map((function(t){return t.value})).indexOf("sub-anchor"),o=r?e.id:e.dataset.id,a=window.location.origin+n().route.discussion(n().current.data.discussion,t.attrs.post.data.attributes.number)+"#"+o;return e.addEventListener("click",(function(){window.copyTextToClipboard("* ["+e.innerText+"]("+a+")")})),m("p",null," ",m("a",{href:a,target:"_self","data-number":t.attrs.post.data.attributes.number,"data-isAnchor":r,"data-id":o,"data-tag":e.tagName,onclick:function(e){return e.preventDefault(),n().current.data.stream.goToNumber(t.attrs.post.data.attributes.number).then((function(){setTimeout((function(){window.location.hash="#"+o,setTimeout((function(){m.redraw()}),100)}),500)})),!1}},e.innerText+"\n"))})))}})),(0,o.extend)(p().prototype,"view",(function(t){if(n().current){try{var e,r,o,a,s,i,l,u,c,d;null!=(e=n().current)&&null!=(r=e.data)&&null!=(o=r.stream)&&null!=(a=o.posts().find((function(t){var e,r,o,a,s,i;return(null==t||null==(e=t.data)?void 0:e.id)==(null==n()||null==(r=n().current)||null==(o=r.data)||null==(a=o.stream)||null==(s=a.posts()[Math.floor(n().current.data.stream.index-n().current.data.stream.visibleStart)-1>0?Math.floor(n().current.data.stream.index-n().current.data.stream.visibleStart)-1:0])||null==(i=s.data)?void 0:i.id)})))&&null!=(s=a.catalog)&&s.content.length&&t.children.push(m("div",{class:"catalog-icon-mobile",onclick:function(){document.querySelector(".PostStreamScrubber.Dropdown.App-titleControl>button.Button.Dropdown-toggle:first-child").click()}})),t.children.push(m("div",{class:"catalog-top"},n().current.data.stream.progress&&n().current.data.stream.currentPostElement&&(n().current.data.stream.progress>100-n().current.data.stream.percentScreenPost||n().current.data.stream.currentPostElement.scrollHeight<window.innerHeight)?"":null==n()||null==(i=n().current)||null==(l=i.data)||null==(u=l.stream)||null==(c=u.posts().find((function(t){var e,r,o,a,s,i,l,u,c,d,m,p,f,h,w,v,g,b;return(null==t||null==(e=t.data)?void 0:e.id)==(null==(r=n().current)||null==(o=r.data)||null==(a=o.stream)||null==(s=a.posts()[Math.floor((null==(l=n().current)||null==(u=l.data)||null==(c=u.stream)?void 0:c.index)-(null==(d=n().current)||null==(m=d.data)||null==(p=m.stream)?void 0:p.visibleStart))-1>0?Math.floor((null==(f=n().current)||null==(h=f.data)||null==(w=h.stream)?void 0:w.index)-(null==(v=n().current)||null==(g=v.data)||null==(b=g.stream)?void 0:b.visibleStart))-1:0])||null==(i=s.data)?void 0:i.id)})))||null==(d=c.catalog)?void 0:d.content))}catch(t){console.log(t)}return t}})),(0,o.override)(c().prototype,"onmatch",(function(t,e,r,o){return n().current.matches(l())&&this.canonicalizeDiscussionSlug(e.id)===this.canonicalizeDiscussionSlug(m.route.param("id"))&&(e.near==m.route.param("near")&&-1!=window.location.href.indexOf("#")||(c().scrollToPostNumber=e.near||1)),this.__proto__.__proto__.onmatch.call(this,e,r,o)})),(0,o.override)(c().prototype,"render",(function(t,e){if(null!==c().scrollToPostNumber){var r=c().scrollToPostNumber;c().scrollToPostNumber==m.route.param("near")&&-1!=window.location.href.indexOf("#")||setTimeout((function(){return n().current.get("stream").goToNumber(r)})),c().scrollToPostNumber=null}return this.__proto__.__proto__.render.call(this,e)})),(0,o.extend)(l().prototype,"show",(function(t){if(-1!=window.location.href.indexOf("#")&&2==window.location.href.split("#").length){var e=window.location.hash;setTimeout((function(){window.location.hash=e}),250),setTimeout((function(){window.location.hash=e}),500)}})),(0,o.override)(l().prototype,"render",(function(t,e){var r,o,a=this;n().history.push("discussion",e.title()),n().setTitle(e.title()),n().setTitleCount(0),console.log("DiscussionPage-overide");var s=[];if(e.payload&&e.payload.included){var i=e.id();s=e.payload.included.filter((function(t){return"posts"===t.type&&t.relationships&&t.relationships.discussion&&!Array.isArray(t.relationships.discussion.data)&&t.relationships.discussion.data.id===i})).map((function(t){return n().store.getById("posts",t.id)})).sort((function(t,e){return t.number()-e.number()})).slice(0,20)}this.stream=new PostStreamState(e,s);var l=m.route.param("near"),u="reply"===l?"reply":parseInt(l);this.stream.goToNumber(u||(null!=(r=null==(o=s[0])?void 0:o.number())?r:0),!0).then((function(){if(a.discussion=e,n().current.set("discussion",e),n().current.set("stream",a.stream),-1!=window.location.href.indexOf("#")&&2==window.location.href.split("#").length){var t=window.location.href.split("#")[1];setTimeout((function(){window.location.hash="#"+t}),300),setTimeout((function(){window.location.hash="#"+t}),1e3)}}))})),(0,o.override)(l().prototype,"positionChanged",(function(t,e,r){var o=this.discussion;if(o){var a=n().route.discussion(o,this.near=e)+(window.location.hash.substr(1).split("-")[0]==this.near?window.location.hash:"");window.history.replaceState(null,document.title,a),n().history.push("discussion",o.title()),n().session.user&&r>(o.lastReadPostNumber()||0)&&(o.save({lastReadPostNumber:r}),m.redraw())}})),window.updateCatalogTop=function(){var t,e,r,o,a,s;if(null!=n()&&null!=(t=n().current)&&null!=(e=t.data)&&null!=(r=e.stream)&&r.index){var i=document.querySelector('.PostStream-item[data-index="'+Math.floor((null==n()||null==(o=n().current)||null==(a=o.data)||null==(s=a.stream)?void 0:s.index)-1)+'"] li.item-progress');if(n().current.data.stream.progress=Math.floor(100*(n().current.data.stream.index-Math.floor(n().current.data.stream.index))),i&&(i.innerText=Math.floor(n().current.data.stream.progress+n().current.data.stream.percentScreenPost/3)+"%",m.redraw(),n().current.data.stream.progress>100-n().current.data.stream.percentScreenPost||n().current.data.stream.progress<n().current.data.stream.percentScreenPost)){var l=document.querySelector(".PostStreamCurrent");if(!l)return;l.className=l.className.replaceAll("PostStreamCurrent","")}}},window.addEventListener("scroll",window.updateCatalogTop),window.addEventListener("touchmove",window.updateCatalogTop),window.updateCurrentPostClass=function(){var t,e,r,o,a,s;if(null!=n()&&null!=(t=n().current)&&null!=(e=t.data)&&null!=(r=e.stream)&&r.index){var i=document.querySelector(".DiscussionPage-discussion").className.split(" ");(null==n()||null==(o=n().current)||null==(a=o.data)||null==(s=a.stream)?void 0:s.index)>1.2?-1==i.indexOf("streamNotFirst")&&i.push("streamNotFirst"):i=i.filter((function(t){return"streamNotFirst"!=t})),document.querySelector(".DiscussionPage-discussion").className=i.join(" ");var l=document.querySelector('.PostStream-item[data-index="'+Math.floor(n().current.data.stream.index-1)+'"]');n().current.data.stream.percentScreenPost=(window.innerHeight-100)/l.scrollHeight*100-2,n().current.data.stream.currentPostElement=l;var u=document.querySelector(".PostStreamCurrent");if(l!=u&&l)if(l.scrollHeight<window.innerHeight||n().current.data.stream.progress>100-n().current.data.stream.percentScreenPost||n().current.data.stream.progress<n().current.data.stream.percentScreenPost){if(!u)return;u.className=u.className.replaceAll("PostStreamCurrent","")}else{if(l.className+=" PostStreamCurrent",!u)return;u.className=u.className.replaceAll("PostStreamCurrent","")}}},window.addEventListener("scroll",window.updateCurrentPostClass),window.addEventListener("touchmove",window.updateCurrentPostClass),(0,o.extend)(s().prototype,"actionItems",(function(t){t.add("progress",m("span",null),10)}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map
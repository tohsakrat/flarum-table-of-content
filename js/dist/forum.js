(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var o in r)t.o(r,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const r=flarum.core.compat["forum/app"];var o=t.n(r);const n=flarum.core.compat["common/extend"],a=flarum.core.compat["forum/components/CommentPost"];var i=t.n(a);const s=flarum.core.compat["forum/components/DiscussionPage"];var c=t.n(s);const l=flarum.core.compat["forum/resolvers/DiscussionPageResolver"];var u=t.n(l);const d=flarum.core.compat["forum/components/PostStreamScrubber"];var p=t.n(d);o().initializers.add("mypost",(function(){(0,n.extend)(i().prototype,"oncreate",(function(){var t=this,e=function(t){var e=new RegExp(/[\x21-\x2f\x3a-\x40\x5b-\x60\x7B-\x7F]/);return t.replace(e,"-").replaceAll(" ","-")};Array.prototype.slice.call(this.element.querySelectorAll('a[target="_self"]')).forEach((function(t){-1!=t.href.indexOf(window.location.href.split("/").splice(0,4).join("/"))&&(t.onclick=function(e){return e.preventDefault(),o().current.data.stream.goToNumber(t.href.split("/")[5].split("#")[0]).then((function(){t.href.split("/")[5]&&setTimeout((function(){window.location.hash="#"+t.href.split("#")[1],setTimeout((function(){m.redraw()}),100)}),500)})),!1})}));var r=Array.prototype.slice.call(this.element.querySelectorAll(".Post-body :is(h1, h2, h3, h4, h5, h6)"));r.forEach((function(t,o){for(var n=t;!(n=n.parentNode).dataset.number;);t.innerHTML='<span class="title-anchor"></span><span class="title-sub-anchor">'+t.innerHTML+"</span>",t.dataset.id=n.dataset.number+"-"+e(t.innerText)+"-"+(1==r.map((function(t){return e(t.innerText)})).filter((function(r){return r==e(t.innerText)})).length?"":o),t.className+=" title-has-anchor",t.querySelector(".title-anchor").id=t.dataset.id,t.querySelector(".title-sub-anchor").id=t.dataset.id})),this.catalog={},this.catalog.id=this.attrs.post.data.id,o().current.data.stream.posts().find((function(e){return e.data.id==t.catalog.id})).catalog=this.catalog,this.catalog.elements=Array.prototype.slice.call(this.element.querySelectorAll(".Post-body :is(h1, h2, h3, h4, h5, h6,.sub-anchor)")),this.catalog.content=this.catalog.elements.map((function(e){var r=-1!=Array(e.classList).map((function(t){return t.value})).indexOf("sub-anchor"),n=r?e.id:e.dataset.id,a=window.location.origin+"/d/"+t.attrs.post.data.relationships.discussion.data.id+"/"+t.attrs.post.data.attributes.number+"#"+n,i=m("p",null," ",m("a",{href:a,target:"_self","data-number":t.attrs.post.data.attributes.number,"data-isAnchor":r,"data-id":n,"data-tag":e.tagName,onclick:function(t){return t.preventDefault(),o().current.data.stream.goToNumber(i.dom.dataset.number).then((function(){setTimeout((function(){window.location.hash="#"+n,setTimeout((function(){m.redraw()}),100)}),250)})),!1}},e.innerText+"\n"));return i}))})),(0,n.extend)(p().prototype,"view",(function(t){try{var e;t.children.push(m("div",{class:"catalog-top"},null==(e=o().current.data.stream.posts().find((function(t){var e,r;return(null==(e=t.data)?void 0:e.id)==(null==(r=o().current.data.stream.posts()[Math.floor(o().current.data.stream.index-o().current.data.stream.visibleStart)-1>0?Math.floor(o().current.data.stream.index-o().current.data.stream.visibleStart)-1:0].data)?void 0:r.id)})).catalog)?void 0:e.content))}catch(t){console.log(t)}return t})),(0,n.override)(u().prototype,"onmatch",(function(t,e,r,n){return o().current.matches(c())&&this.canonicalizeDiscussionSlug(e.id)===this.canonicalizeDiscussionSlug(m.route.param("id"))&&(e.near==m.route.param("near")&&-1!=window.location.href.indexOf("#")||(u().scrollToPostNumber=e.near||1)),this.__proto__.__proto__.onmatch.call(this,e,r,n)})),(0,n.override)(u().prototype,"render",(function(t,e){if(null!==u().scrollToPostNumber){var r=u().scrollToPostNumber;u().scrollToPostNumber==m.route.param("near")&&-1!=window.location.href.indexOf("#")||setTimeout((function(){return o().current.get("stream").goToNumber(r)})),u().scrollToPostNumber=null}return this.__proto__.__proto__.render(e)})),(0,n.override)(c().prototype,"render",(function(t,e){var r,n,a=this;o().history.push("discussion",e.title()),o().setTitle(e.title()),o().setTitleCount(0),console.log("DiscussionPage-overide");var i=[];if(e.payload&&e.payload.included){var s=e.id();i=e.payload.included.filter((function(t){return"posts"===t.type&&t.relationships&&t.relationships.discussion&&!Array.isArray(t.relationships.discussion.data)&&t.relationships.discussion.data.id===s})).map((function(t){return o().store.getById("posts",t.id)})).sort((function(t,e){return t.number()-e.number()})).slice(0,20)}this.stream=new PostStreamState(e,i);var c=m.route.param("near"),l="reply"===c?"reply":parseInt(c);this.stream.goToNumber(l||(null!=(r=null==(n=i[0])?void 0:n.number())?r:0),!0).then((function(){if(a.discussion=e,o().current.set("discussion",e),o().current.set("stream",a.stream),-1!=window.location.href.indexOf("#")&&2==window.location.href.split("#").length){var t=window.location.href.split("#")[1];setTimeout((function(){window.location.hash="#"+t}),1e3),setTimeout((function(){window.location.hash="#"+t}),2e3)}}))})),window.updateCatalogTop=function(){m.redraw()},window.addEventListener("scroll",window.updateCatalogTop)}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map
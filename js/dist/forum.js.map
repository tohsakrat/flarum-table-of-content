{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@tohsakarat/table-of-content/webpack/bootstrap","webpack://@tohsakarat/table-of-content/webpack/runtime/compat get default export","webpack://@tohsakarat/table-of-content/webpack/runtime/define property getters","webpack://@tohsakarat/table-of-content/webpack/runtime/hasOwnProperty shorthand","webpack://@tohsakarat/table-of-content/webpack/runtime/make namespace object","webpack://@tohsakarat/table-of-content/external root \"flarum.core.compat['forum/app']\"","webpack://@tohsakarat/table-of-content/external root \"flarum.core.compat['common/extend']\"","webpack://@tohsakarat/table-of-content/external root \"flarum.core.compat['forum/components/CommentPost']\"","webpack://@tohsakarat/table-of-content/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@tohsakarat/table-of-content/external root \"flarum.core.compat['forum/resolvers/DiscussionPageResolver']\"","webpack://@tohsakarat/table-of-content/external root \"flarum.core.compat['forum/components/PostStreamScrubber']\"","webpack://@tohsakarat/table-of-content/./src/forum/index.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/CommentPost'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/resolvers/DiscussionPageResolver'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStreamScrubber'];","import app from 'flarum/forum/app';\nimport  { extend, override } from 'flarum/common/extend';\nimport CommentPost from 'flarum/forum/components/CommentPost';\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport DiscussionPageResolver from 'flarum/forum/resolvers/DiscussionPageResolver';\nimport PostStreamScrubber from 'flarum/forum/components/PostStreamScrubber';\napp.initializers.add('mypost', () => {\n//console.log(12345)\n  extend(CommentPost.prototype, 'oncreate', function () {\n    //console.log(this);\n    let clearPunctuation=(str)=>{;\n      let reg=new RegExp( /[\\x21-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7B-\\x7F]/)\n      return str.replace( reg ,'-').replaceAll(' ','-');\n  }\n\n  //console.log(this)\n // if(!this.element)return items\n \n  let inPageLink=Array.prototype.slice.call(this.element.querySelectorAll('a[target=\"_self\"]'))\n  \n     inPageLink.forEach((e)=>{\n      if(e.href.indexOf(window.location.href.split('/').splice(0,4).join('/'))!=-1)e.onclick=(w)=>{\n      \n      w.preventDefault();\n      \n     app.current.data.stream.goToNumber(e.href.split('/')[5].split('#')[0]).then(()=>{\n    \t\t  if(e.href.split('/')[5])setTimeout(()=>{\n    \t\t\t//console.log(a)\n    \t\t  window.location.hash  =  '#'+ e.href.split('#')[1];\n    \t\t  setTimeout(()=>{ m.redraw();},100)\n    \t\t},500)}\n    \t\t)\n      return false;\n      \n      }\n    \n    \n    })\n \n \n \n \n \n \n \n \n \n \n \n \n \n \n  let elements1=Array.prototype.slice.call(this.element.querySelectorAll('.Post-body :is(h1, h2, h3, h4, h5, h6)'))\n  \n  \n  elements1.forEach((e,i)=>{\n    let anchor=e\n    while(1){\n    anchor = anchor.parentNode\n    if(anchor.dataset.number)break\n    }\n    e.innerHTML='<span class=\"title-anchor\"></span>'+ '<span class=\"title-sub-anchor\">'+ e.innerHTML+'</span>'; \n   //e.id=\n    e.dataset.id=anchor.dataset.number+'-'+clearPunctuation(e.innerText)+'-'+(elements1.map(k=>clearPunctuation(k.innerText)).filter(b=>b==clearPunctuation(e.innerText)).length==1?'':i);;\n    e.className+=' title-has-anchor';\n    e.querySelector('.title-anchor').id = e.dataset.id;\n    e.querySelector('.title-sub-anchor').id = e.dataset.id;\n   \n  })\n  this.catalog={}\n  this.catalog.id=this.attrs.post.data.id\n  \n  app.current.data.stream.posts().find(u=>u.data.id== this.catalog.id).catalog=this.catalog\n  this.catalog.elements=Array.prototype.slice.call(this.element.querySelectorAll('.Post-body :is(h1, h2, h3, h4, h5, h6,.sub-anchor)'))\n  this.catalog.content=this.catalog.elements.map(\n      (e)=>{\n        \n        let isAnchor=Array(e.classList).map(e=>e.value).indexOf('sub-anchor')!=-1\n        let id=isAnchor? e.id : e.dataset.id\n       let link=     window.location.origin+'/d/'+this.attrs.post.data.relationships.discussion.data.id + '/'+this.attrs.post.data.attributes.number+'#'+id\n        let a=<p> <a\n        href={link}\n        target='_self'\n        data-number={this.attrs.post.data.attributes.number}\n        \n        data-isAnchor={isAnchor}\n        data-id={id}\n        data-tag={e.tagName}\n        onclick={(u)=>{  \n\n          u.preventDefault();\n           app.current.data.stream.goToNumber(a.dom.dataset.number).then(()=>{\n              setTimeout(()=>{\n                //console.log(a)\n              window.location.hash  =  '#'+ id;\n               setTimeout(()=>{ m.redraw();},100)\n            },250)}\n            )\n            return false;\n          }\n        }\n        >{e.innerText+'\\n'}</a></p>\n    \n       \n      \n       // a= document.createTextNode(a)\n       // console.log('#'+e.dataset.id)\n       \n        //this.element.querySelector('.Post-header').appendChild(a)\n        \n       //a=$(a)\n       \n        return a;\n        //console.log(a)\n       // console.log(items)\n      //  items.push(a)\n      //  console.log(a)\n        //this.content[0]\n      }\n      )\n      \n   //   app.catalog={\n    //    view:function(){\n   //       return <div class=\"catalogDIV\">{content}</div>\n   //     }\n      \n  //    }\n\n  //    app.catalog.content=this.catalog.content;\n\n  //console.log('啊吧啊吧')\n\n\n    // console.log(this)\n    \n     //console.log(CommentPost.prototype)\n\n\n\n     //return items; \n\n\n    }); \n\n\n    extend(PostStreamScrubber.prototype, 'view', function (vnode){\n      // if(app.current.data.stream.posts().filter((w)=>{return w.attributes.number==this.attrs.post.data.attributes.number})[0])app.current.data.stream.posts().filter((w)=>{return w.attributes.number==this.attrs.post.data.attributes.number})[0].catalog=this.catalog\n\n      \n        try{\n         if(app.current.data.stream.posts().find(u=>u.data?.id==app.current.data.stream.posts()[Math.floor(app.current.data.stream.index-app.current.data.stream.visibleStart)-1>0?Math.floor(app.current.data.stream.index-app.current.data.stream.visibleStart)-1:0].data?.id)\n        .catalog?.content.length) vnode.children.push(<div class='catalog-icon-mobile'></div>)\n        vnode.children.push(<div class='catalog-top'>\n            {app.current.data.stream.posts().find(u=>u.data?.id==app.current.data.stream.posts()[Math.floor(app.current.data.stream.index-app.current.data.stream.visibleStart)-1>0?Math.floor(app.current.data.stream.index-app.current.data.stream.visibleStart)-1:0].data?.id)\n           .catalog?.content}\n\n        </div>)}catch (e){\n            console.log(e)\n        }\n        //console.log( app.current.data.stream.posts().find(u=>u.data.id==app.current.data.stream.posts()[Math.floor(app.current.data.stream.index-app.current.data.stream.visibleStart)].data.id).catalog?.content)\n           \n       return vnode\n \n \n       })\n       \n      // m.redraw()\n  \n      override(DiscussionPageResolver.prototype, 'onmatch', function (original, args, requestedPath, route){\n        \n      if (app.current.matches(DiscussionPage) && this.canonicalizeDiscussionSlug(args.id) === this.canonicalizeDiscussionSlug(m.route.param('id'))) {\n        // By default, the first post number of any discussion is 1\n       if(args.near!=m.route.param('near') || window.location.href.indexOf('#')==-1 )DiscussionPageResolver.scrollToPostNumber = args.near || 1;//在贴在路由不变情况下不要滚回开头\n\n      }\n     // console.log('original DicussionPageResolver')\n      //console.log(this.__proto__.__proto__.onmatch)\n      return this.__proto__.__proto__.onmatch.call(this, args, requestedPath, route);\n    })\n\n    override(DiscussionPageResolver.prototype, 'render', function (original, vnode){\n      if (DiscussionPageResolver.scrollToPostNumber !== null) {\n        const number = DiscussionPageResolver.scrollToPostNumber;\n        // Scroll after a timeout to avoid clashes with the render.\n        \n       if(DiscussionPageResolver.scrollToPostNumber!=m.route.param('near')|| window.location.href.indexOf('#')==-1 ) setTimeout(() => app.current.get('stream').goToNumber(number));//在贴在路由不变情况下不要滚回开头\n        \n  \n        DiscussionPageResolver.scrollToPostNumber = null;\n      }\n  \n      return this.__proto__.__proto__.render.call(this,vnode);\n    })\n\n\n    override(DiscussionPage.prototype, 'render', function (original,discussion){\n      app.history.push('discussion', discussion.title());\n      app.setTitle(discussion.title());\n      app.setTitleCount(0);\n      console.log('DiscussionPage-overide')\n      // When the API responds with a discussion, it will also include a number of\n      // posts. Some of these posts are included because they are on the first\n      // page of posts we want to display (determined by the `near` parameter) –\n      // others may be included because due to other relationships introduced by\n      // extensions. We need to distinguish the two so we don't end up displaying\n      // the wrong posts. We do so by filtering out the posts that don't have\n      // the 'discussion' relationship linked, then sorting and splicing.\n      let includedPosts = [];\n      if (discussion.payload && discussion.payload.included) {\n        const discussionId = discussion.id();\n  \n        includedPosts = discussion.payload.included\n          .filter(\n            (record) =>\n              record.type === 'posts' &&\n              record.relationships &&\n              record.relationships.discussion &&\n              !Array.isArray(record.relationships.discussion.data) &&\n              record.relationships.discussion.data.id === discussionId\n          )\n          // We can make this assertion because posts should be in the store,\n          // since they were in the discussion's payload.\n          .map((record) => app.store.getById('posts', record.id) )\n          .sort((a, b) => a.number() - b.number())\n          .slice(0, 20);\n      }\n  \n      // Set up the post stream for this discussion, along with the first page of\n      // posts we want to display. Tell the stream to scroll down and highlight\n      // the specific post that was routed to.\n      this.stream = new PostStreamState(discussion, includedPosts);\n      const rawNearParam = m.route.param('near');\n      const nearParam = rawNearParam === 'reply' ? 'reply' : parseInt(rawNearParam);\n    \n      this.stream.goToNumber(nearParam || (includedPosts[0]?.number() ?? 0), true).then(() => {\n        this.discussion = discussion;\n  \n        app.current.set('discussion', discussion);\n        app.current.set('stream', this.stream);\n      if(window.location.href.indexOf('#')!=-1 && window.location.href.split('#').length==2){\n      let hash=window.location.href.split('#')[1]\n      \n      setTimeout(()=>{\n      window.location.hash  =   '#'+hash;\n      },1000)\n      setTimeout(()=>{\n      window.location.hash  =   '#'+hash;\n      },2000)\n      }\n      \n      \n      \n      });\n      \n      \n  \n    })\n\n\n    /**\n   * When the posts that are visible in the post stream change (i.e. the user\n   * scrolls up or down), then we update the URL and mark the posts as read.\n   */\n\n    override(DiscussionPage.prototype, 'positionChanged', function(original,startNumber, endNumber){\n    const discussion = this.discussion;\n\n    if (!discussion) return;\n\n    // Construct a URL to this discussion with the updated position, then\n    // replace it into the window's history and our own history stack.\n    const url = app.route.discussion(discussion, (this.near = startNumber))+(window.location.hash.substr(1).split('-')[0]==this.near?window.location.hash:'');\n\n    window.history.replaceState(null, document.title, url);\n    app.history.push('discussion', discussion.title());\n\n    // If the user hasn't read past here before, then we'll update their read\n    // state and redraw.\n    if (app.session.user && endNumber > (discussion.lastReadPostNumber() || 0)) {\n      discussion.save({ lastReadPostNumber: endNumber });\n      m.redraw();\n    }\n  });\n  \n  \n  \n\n\n    window.updateCatalogTop=()=>{\n      m.redraw();\n    }\n\n        window.addEventListener('scroll', window.updateCatalogTop); \n\n   //this.catalog.children=app.current.data.stream?.posts()[app.current.data.stream.visible]\n   //return callback;\n\n   // document.querySelector(\"#content\").dataset.streamNear=this.near\n   // $('.item-scrubber>.Dropdown-menu.dropdown-menu')[0].append\n\n  \n})\n  \n  \n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","flarum","core","compat","app","extend","CommentPost","clearPunctuation","str","reg","RegExp","replace","replaceAll","Array","slice","this","element","querySelectorAll","forEach","e","href","indexOf","window","location","split","splice","join","onclick","w","preventDefault","then","setTimeout","hash","m","redraw","elements1","i","anchor","parentNode","dataset","number","innerHTML","id","innerText","map","k","filter","b","length","className","querySelector","catalog","attrs","post","data","find","u","elements","content","isAnchor","classList","link","origin","relationships","discussion","attributes","target","tagName","dom","PostStreamScrubber","vnode","Math","floor","children","push","class","console","log","override","DiscussionPageResolver","original","args","requestedPath","route","DiscussionPage","canonicalizeDiscussionSlug","param","near","__proto__","onmatch","goToNumber","render","title","includedPosts","payload","included","discussionId","record","type","isArray","sort","stream","PostStreamState","rawNearParam","nearParam","parseInt","startNumber","endNumber","url","substr","history","replaceState","document","lastReadPostNumber","save","updateCatalogTop","addEventListener"],"sourceRoot":""}